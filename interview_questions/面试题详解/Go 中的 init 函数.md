# 面试题解答：Go 中的 init 函数

## 一、基础认知：init 函数是什么？
**`init` 函数**是 Go 语言中的一种**特殊函数**，它没有参数和返回值，也不能被手动调用。  
Go 程序在启动时，会自动调用每个包中的 `init` 函数，用于**包的初始化工作**。

```go
package mypkg

import "fmt"

func init() {
    fmt.Println("mypkg init")
}
```

---

## 二、执行机制：init 函数的执行时机与顺序

### 1. 执行时机
- `init` 函数在**包被导入时自动执行**，在 `main` 函数执行之前完成；
- 它执行在**全局变量初始化之后**，但在**包内函数调用之前**。

### 2. 执行顺序规则
Go 程序的初始化顺序是：

1. **按包依赖关系**：先初始化被依赖的包，再初始化依赖它的包；
2. **包内顺序**：
   - 先初始化**全局变量**；
   - 再执行**`init` 函数**（一个包可以有多个 `init` 函数，按文件中出现的顺序执行）；
3. **最后执行** `main.main` 函数。

**示例**：
```go
// a.go
package main

import "fmt"

var A = initA()

func initA() int {
    fmt.Println("init A")
    return 1
}

func init() {
    fmt.Println("init 1")
}

func init() {
    fmt.Println("init 2")
}

func main() {
    fmt.Println("main")
}
```
输出：
```
init A
init 1
init 2
main
```

---

## 三、使用场景：init 函数的典型用途

### 1. 初始化包内变量
有些全局变量需要复杂的初始化逻辑，这时可以放在 `init` 函数中：
```go
var config Config

func init() {
    config = loadConfigFromFile("config.json")
}
```

### 2. 注册驱动或插件
数据库驱动、HTTP 处理器等通常在 `init` 函数中注册：
```go
func init() {
    sql.Register("mysql", &MySQLDriver{})
}
```

### 3. 检查或修复程序状态
在程序启动时验证必要条件，如配置文件是否存在、端口是否可用等：
```go
func init() {
    if !fileExists("config.json") {
        log.Fatal("config.json not found")
    }
}
```

### 4. 执行一次性计算
某些算法需要预处理数据（如生成查找表），可以放在 `init` 函数中：
```go
var lookupTable []int

func init() {
    lookupTable = precomputeTable()
}
```

---

## 四、注意事项与最佳实践

### 1. 不能手动调用
`init` 函数由 Go  runtime 自动调用，不能在代码中显式调用：
```go
init() // 编译错误
```

### 2. 没有参数和返回值
```go
func init() {} // 正确
func init(x int) {} // 编译错误
```

### 3. 一个包可以有多个 init 函数
多个 `init` 函数按在文件中出现的顺序执行，不同文件按文件名排序执行。

### 4. 避免耗时操作
`init` 函数会阻塞程序启动，应避免在其中执行耗时操作（如网络请求）。

### 5. 避免依赖其他包的 init 副作用
虽然可以，但应谨慎依赖其他包 `init` 函数的副作用，这会降低代码可读性。

---

## 五、面试延伸：加分考点

### 1. init 函数与全局变量初始化的执行顺序？
- 全局变量初始化表达式 → `init` 函数 → `main` 函数
- 如果全局变量初始化依赖其他包的变量，则会先初始化依赖包

### 2. init 函数与 main 函数的区别？
| 对比维度 | init 函数 | main 函数 |
|----------|-----------|-----------|
| 定义位置 | 任何包都可以有 | 只能在 main 包中 |
| 执行时机 | 包初始化时自动执行 | 所有初始化完成后执行 |
| 参数/返回值 | 无 | `(int)` 返回值表示退出码 |
| 调用方式 | 自动调用 | 程序入口，自动调用 |

### 3. 如何控制多个 init 函数的执行顺序？
- 在同一个文件中，按出现顺序执行；
- 在同一个包的不同文件中，按文件名排序执行；
- 跨包的顺序由导入依赖关系决定。

### 4. init 函数的执行是否并发？
- 否，所有初始化（包括 `init` 函数）都在**单个 Goroutine**中完成，顺序执行。

---

## 六、总结：面试答题模板（直接套用）
> Go 中的 `init` 函数是一种特殊的初始化函数，没有参数和返回值，由 Go runtime 自动调用。  
> 它在包被导入时执行，位于全局变量初始化之后、`main` 函数之前。  
> 执行顺序遵循包依赖关系，先初始化被依赖的包，再初始化依赖它的包；包内先执行全局变量初始化，再按顺序执行 `init` 函数。  
> `init` 函数常用于初始化包内变量、注册驱动、检查程序状态等一次性初始化工作。  
> 使用时应避免耗时操作，不要手动调用，也不要过度依赖其他包 `init` 函数的副作用。  
> 与 `main` 函数不同，`init` 可以在任何包中定义，且一个包可以有多个 `init` 函数。
